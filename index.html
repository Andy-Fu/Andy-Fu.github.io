<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>家族关系表</title>
    <style>
        /*CSS*/
        html, body {
            margin: 0px;
            padding: 0px;
            width: 100%;
            height: 100%;
            font-family: Helvetica;
            overflow: hidden;
        }

        #tree {
            width: 100%;
            height: 100%;
        }

        #tree > svg > g > text{
            fill: black;
        }
    </style>
</head>
<body>
<!--HTML-->
<script src="https://balkan.app/js/FamilyTree.js"></script>
<div id="tree"></div>
  <script>
   //JavaScript
    // 家族数据结构示例
    var familyData = []
    fetch('./new_family.json').then(response => response.json())
    .then(data => {
            console.log('原始数据:', data);
            
            // 预处理数据，处理父子关系
            const processedData = data.map(node => {
                // 基础节点数据
                const processedNode = {
                    id: parseInt(node.id),
                    name: node.name,
                    title: node.title || '',
                    description: node.description || '',
                    gender: node.gender || 'male',
                    generation: "第 "+(node.generation || 0) + "代",
                    // 生成基于名字的头像URL
                    img: `https://ui-avatars.com/api/?name=${encodeURIComponent(node.name)}&background=random&size=150&font-size=0.5&length=2&color=ffffff`
                };
                 // 如果有父亲，设置 pid
                 if (node.fid) {
                    processedNode.fid = parseInt(node.fid);
                }

                return processedNode;
            });
            
            console.log('处理后的数据:', processedData);
            
            var options = getOptions();

            var chart = new FamilyTree(document.getElementById("tree"), {
                mouseScrool: FamilyTree.action.zoom,
                scaleInitial: options.scaleInitial,
                siblingSeparation: 80,
                levelSeparation: 120,
                template: "john",
                editForm: {
                    buttons: {
                        edit: null,
                        share: null,
                        pdf: {
                            icon: FamilyTree.icon.pdf(24, 24, '#fff'),
                            text: 'Save as PDF'
                        }
                    }
                },
                nodeBinding: {
                    field_0: "title",
                    field_1: "generation",
                    img_0: "img",
                },
                maxDepth: 5,
                orientation: FamilyTree.orientation.top,
                orderBy: "generation",
                tags: {
                    color: '#757575',
                    stroke: '#757575',
                    strokeWidth: 2,
                },  
                padding: 30,
                zoom: {
                    speed: 130,
                    smooth: 10
                }
            });

            // 修改模板中的文本位置
            FamilyTree.templates.john.field_0 = 
                '<text class="field_0" style="font-size: 18px;" fill="#000000" x="125" y="145" text-anchor="middle">{val}</text>';
            FamilyTree.templates.john.field_1 = 
                '<text class="field_1" style="font-size: 14px;" fill="#666666" x="125" y="125" text-anchor="middle">{val}</text>';

            // 在加载后调整文本位置
            chart.on('redraw', function(sender) {
                setTimeout(() => {
                    const texts = document.querySelectorAll('#tree > svg > g > text');
                    texts.forEach(text => {
                        if (text.getAttribute('data-width') === "230") {
                            text.setAttribute('y', '145');
                        } else if (text.getAttribute('data-width') === "150") {
                            text.setAttribute('y', '165');
                        }
                    });
                }, 100);
            });

            chart.load(processedData);

    })
    .catch(error => {
        console.error('错误详情:', error);
        alert('加载家谱数据时发生错误，请检查控制台获取详细信息');
    });


    function getOptions(){
        const searchParams = new URLSearchParams(window.location.search);
        var fit = searchParams.get('fit');
        var enableSearch = true;
        var scaleInitial = 1;
        if (fit == 'yes'){
            enableSearch = false;
            scaleInitial = FamilyTree.match.boundary;
        }
        return {enableSearch, scaleInitial};
    }
  </script>
  </body>
  </html>
